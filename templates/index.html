<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web Media Analyzer</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/datatables@1.10.18/media/css/jquery.dataTables.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
    <script src="https://unpkg.com/vis-timeline@latest/standalone/umd/vis-timeline-graph2d.min.js"></script>
    <link href="https://unpkg.com/vis-timeline@latest/styles/vis-timeline-graph2d.min.css" rel="stylesheet" type="text/css" />
    <style>
        body { 
            padding: 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        .table { margin-top: 20px; }
        #results { margin-top: 30px; }
        
        /* Footer styles */
        footer {
            margin-top: auto;
            padding: 20px 0;
            text-align: center;
            color: #666;
            border-top: 1px solid #eee;
        }
        
        /* Spinner styles */
        .spinner-container {
            display: none;
            margin: 20px 0;
            text-align: center;
        }
        .spinner-text {
            margin-top: 10px;
            font-style: italic;
            color: #666;
        }
        .sort-button {
            background: none;
            border: none;
            padding: 0 5px;
            cursor: pointer;
        }
        .filter-controls {
            margin-bottom: 15px;
        }
        .table-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        #timeline {
            display: none;
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        #visualization {
            height: 300px;
        }
        .domain-event {
            background-color: #007bff !important;
            color: white !important;
            border-color: #0056b3 !important;
            font-weight: bold;
        }
        .header-event {
            background-color: #28a745 !important;
            color: white !important;
            border-color: #1e7e34 !important;
        }
        .vis-item.vis-selected {
            background-color: #17a2b8 !important;
            border-color: #138496 !important;
        }
        /* Add timeline styles */
        .timeline-rdap {
            background-color: #007bff !important;
            color: white !important;
            border-color: #0056b3 !important;
        }
        
        .timeline-cert {
            background-color: #dc3545 !important;
            color: white !important;
            border-color: #bd2130 !important;
        }
        
        .timeline-header {
            background-color: #28a745 !important;
            color: white !important;
            border-color: #1e7e34 !important;
        }
        
        .timeline-favicon {
            background-color: #ffc107 !important;
            color: black !important;
            border-color: #d39e00 !important;
        }
        
        #visualization {
            margin-top: 20px;
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 4px;
            min-height: 300px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Web Media Analyzer</h1>
        <form id="searchForm">
            <div class="form-group">
                <div class="input-group">
                    <input type="text" class="form-control" id="url" name="url" placeholder="Enter URL here..." required>
                    <button type="submit" class="btn btn-primary">Analyze</button>
                </div>
            </div>
            
            <div class="form-group mt-3 d-flex gap-4">
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="searchType" id="allTypes" value="all" checked>
                    <label class="form-check-label" for="allTypes">
                        All Analysis Types
                        <i class="bi bi-info-circle ms-1" data-bs-toggle="tooltip" data-bs-placement="top" 
                           title="Performs all available checks: domain age via RDAP, SSL certificates history from crt.sh, and last-modified headers for all media files. These techniques are a mix of active and passive."></i>
                    </label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="searchType" id="rdapOnly" value="rdap">
                    <label class="form-check-label" for="rdapOnly">
                        Domain History Only
                        <i class="bi bi-info-circle ms-1" data-bs-toggle="tooltip" data-bs-placement="top" 
                           title="Checks domain registration and update history using RDAP data. This is a passive technique and will not interact with the target website."></i>
                    </label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="searchType" id="certsOnly" value="certs">
                    <label class="form-check-label" for="certsOnly">
                        Certificate History Only
                        <i class="bi bi-info-circle ms-1" data-bs-toggle="tooltip" data-bs-placement="top" 
                           title="Retrieves SSL certificate history from crt.sh database. This is a passive technique and will not interact with the target website."></i>
                    </label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="searchType" id="headersOnly" value="headers">
                    <label class="form-check-label" for="headersOnly">
                        Last-Modified Headers Only
                        <i class="bi bi-info-circle ms-1" data-bs-toggle="tooltip" data-bs-placement="top" 
                           title="Checks last-modified dates for all media files (images, favicons) on the webpage. This is an active technique and will interact with the target website."></i>
                    </label>
                </div>
            </div>

        </form>

        <!-- Loading Spinner -->
        <div id="spinner" class="spinner-container">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <div class="spinner-text">Analyzing URL... This may take a few moments.</div>
        </div>

        <div id="results" class="mt-4" style="display: none;">
            <!-- Add URL title and Export All button at the top -->
            <h2 class="mb-3">Results for URL: <span id="analyzed-url" class="text-primary"></span></h2>
            <div class="mb-4">
                <button class="btn btn-primary" onclick="exportAll()">Export All Data</button>
            </div>

            <div id="domain-info" class="mt-4">
                <h3>Domain Information</h3>
                <div class="table-controls">
                    <button class="btn btn-secondary" onclick="exportTable('rdap')">Export RDAP Data</button>
                </div>
                <table class="table table-striped" id="domain-table">
                    <thead>
                        <tr>
                            <th>Type</th>
                            <th>URL</th>
                            <th>Time</th>
                        </tr>
                    </thead>
                    <tbody id="domain-results">
                    </tbody>
                </table>
            </div>

            <!-- Certificate table with export button -->
            <div id="ssl-certificate" class="mt-4">
                <h3>SSL Certificate Information</h3>
                <div class="table-controls">
                    <button class="btn btn-secondary" onclick="exportTable('certs')">Export Certificate Data</button>
                </div>
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Type</th>
                            <th>Common Name</th>
                            <th>First Seen</th>
                            <th>Valid From</th>
                            <th>Source</th>
                        </tr>
                    </thead>
                    <tbody id="ssl-certificate-results">
                    </tbody>
                </table>
            </div>

            <div id="headers-info" class="mt-4">
                <h3>Last Modified Headers</h3>
                <div class="table-controls">
                    <div>
                        <button class="btn btn-secondary" onclick="exportTable('headers')">Export Headers Data</button>
                        <select id="type-filter" class="form-select d-inline-block w-auto ms-2" onchange="filterHeadersResults()">
                            <option value="all">All Types</option>
                            <option value="favicon">Favicon</option>
                            <option value="image">Image</option>
                        </select>
                    </div>
                </div>
                <table class="table table-striped" id="headers-table">
                    <thead>
                        <tr>
                            <th>Type</th>
                            <th>URL</th>
                            <th>Last Modified</th>
                        </tr>
                    </thead>
                    <tbody id="headers-results">
                    </tbody>
                </table>
            </div>

            <!-- Move timeline button inside results div and hide by default -->
            <div class="mt-4" id="timelineButtonContainer" style="display: none;">
                <button class="btn btn-primary" id="viewTimelineBtn" onclick="window.showTimeline()">View Timeline</button>
            </div>
        </div>

        <!-- First, make sure the timeline container is properly structured -->
        <div id="timeline" class="mt-4">
            <h3>Timeline</h3>
            <div class="mb-3">
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="checkbox" id="showRdap" checked>
                    <label class="form-check-label" for="showRdap">
                        <span class="badge bg-primary">Domain Registration Events</span>
                    </label>
                </div>
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="checkbox" id="showCerts" checked>
                    <label class="form-check-label" for="showCerts">
                        <span class="badge bg-danger">First SSL Certificate</span>
                    </label>
                </div>
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="checkbox" id="showHeaders" checked>
                    <label class="form-check-label" for="showHeaders">
                        <span class="badge bg-success">Image Last Modified</span>
                    </label>
                </div>
            </div>
            <div id="visualization"></div>
        </div>

        <div id="error" class="alert alert-danger d-none"></div>
    </div>

    <footer>
        <div class="container">
            Copyright Â© Steven Harris  <span id="copyright-year"></span> <a href="https://www.nixintel.info" target="_blank">www.nixintel.info</a> 
        </div>
    </footer>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.10.24/js/jquery.dataTables.min.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // Set copyright year
        document.getElementById('copyright-year').textContent = new Date().getFullYear();

        // Initialize all tooltips
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl)
        });

        console.log('Page loaded');
        
        // Get DOM elements
        const searchForm = document.getElementById('searchForm');
        const spinner = document.getElementById('spinner');
        const results = document.getElementById('results');
        const errorDiv = document.getElementById('error');

        // Initialize DataTables
        let domainTable = null;
        let headersTable = null;

        if (!searchForm) {
            console.error('Search form not found!');
            return;
        }

        console.log('Form found:', searchForm);

        // Initialize global variables
        window.domainResults = [];
        window.certResults = [];
        window.headerResults = [];
        window.headersPagination = { currentPage: 1, perPage: 10 };
        window.currentTimeline = null;

        let timeline = null;
        let timelineItems = new vis.DataSet();
        
        function createTimeline(data) {
            const container = document.getElementById('visualization');
            
            // Clear existing items
            timelineItems.clear();
            
            let items = [];
            let itemId = 1;
            let minDate = null;
            let maxDate = null;
            
            // Process RDAP data
            if (data.rdap) {
                data.rdap.forEach(item => {
                    if (item.error) return; // Skip error messages
                    const date = parseDate(item.last_modified);
                    if (date) {
                        const label = item.type === 'Registered' ? 'Domain first registered' : 
                                    item.type === 'Updated' ? 'Domain registration last updated' : 
                                    item.type;
                        items.push({
                            id: itemId++,
                            content: label,
                            start: date,
                            className: 'timeline-rdap',
                            group: 'rdap',
                            title: `${label}<br>${item.last_modified}`
                        });
                        if (!minDate || date < minDate) minDate = date;
                        if (!maxDate || date > maxDate) maxDate = date;
                    }
                });
            }
            
            // Process Certificate data
            if (data.certs) {
                const certData = Array.isArray(data.certs) ? data.certs : [data.certs];
                certData.forEach(item => {
                    const firstSeen = parseDate(item['First Seen']);
                    if (firstSeen) {
                        items.push({
                            id: itemId++,
                            content: 'First SSL certificate',
                            start: firstSeen,
                            className: 'timeline-cert',
                            group: 'certs',
                            title: `First SSL certificate<br>First Seen: ${item['First Seen']}<br>Valid From: ${item['Valid From']}`
                        });
                        if (!minDate || firstSeen < minDate) minDate = firstSeen;
                        if (!maxDate || firstSeen > maxDate) maxDate = firstSeen;
                    }
                });
            }
            
            // Process Headers data
            if (data.headers) {
                data.headers.forEach(item => {
                    const date = parseDate(item.last_modified);
                    if (date) {
                        const isFavicon = item.type.toLowerCase() === 'favicon';
                        const label = isFavicon ? 'Favicon last modified' : 'Image last modified';
                        items.push({
                            id: itemId++,
                            content: label,
                            start: date,
                            className: isFavicon ? 'timeline-favicon' : 'timeline-header',
                            group: 'headers',
                            title: `${label}<br>${item.last_modified}<br>${item.url}`
                        });
                        if (!minDate || date < minDate) minDate = date;
                        if (!maxDate || date > maxDate) maxDate = date;
                    }
                });
            }
            
            // Add items to the dataset
            timelineItems.add(items);
            
            // Configure timeline options
            const options = {
                height: '300px',
                showCurrentTime: false,
                showTooltips: true,
                horizontalScroll: true,
                zoomable: true,
                groupOrder: 'content',  // Order groups alphabetically
                margin: { item: { horizontal: 10 }}, // Add margin between items
                orientation: 'top'
            };
            
            // Create or update timeline
            if (timeline === null) {
                timeline = new vis.Timeline(container, timelineItems, options);
            } else {
                timeline.setOptions(options);
                timeline.setItems(timelineItems);
            }
            
            // Set initial window with padding
            if (minDate && maxDate) {
                const timeSpan = maxDate - minDate;
                const padding = timeSpan * 0.1; // 10% padding on each side
                timeline.setWindow(
                    new Date(minDate.getTime() - padding),
                    new Date(maxDate.getTime() + padding)
                );
            }
            
            // Show timeline container
            document.getElementById('timeline').style.display = 'block';
            
            // Initial visibility update
            updateTimelineVisibility();
        }
        
        function parseDate(dateStr) {
            try {
                const [date, time] = dateStr.split(' ');
                const [day, month, year] = date.split('-');
                if (time) {
                    const [hours, minutes, seconds] = time.split(':');
                    return new Date(year, month - 1, day, hours || 0, minutes || 0, seconds || 0);
                }
                return new Date(year, month - 1, day);
            } catch (e) {
                console.error('Error parsing date:', dateStr, e);
                return null;
            }
        }
        
        function updateTimelineVisibility() {
            const showRdap = document.getElementById('showRdap').checked;
            const showCerts = document.getElementById('showCerts').checked;
            const showHeaders = document.getElementById('showHeaders').checked;
            
            let visibleItems = [];
            
            timelineItems.forEach(item => {
                if ((item.group === 'rdap' && showRdap) ||
                    (item.group === 'certs' && showCerts) ||
                    (item.group === 'headers' && showHeaders)) {
                    visibleItems.push(item);
                }
            });
            
            if (timeline) {
                timeline.setItems(new vis.DataSet(visibleItems));
            }
        }
        
        // Add event listeners for checkboxes
        document.getElementById('showRdap').addEventListener('change', updateTimelineVisibility);
        document.getElementById('showCerts').addEventListener('change', updateTimelineVisibility);
        document.getElementById('showHeaders').addEventListener('change', updateTimelineVisibility);
        
        // Form submission handler
        searchForm.addEventListener('submit', async function(event) {
            event.preventDefault();
            console.log('Form submitted');
            
            const urlInput = document.getElementById('url');
            const url = urlInput.value;
            const searchType = document.querySelector('input[name="searchType"]:checked').value;
            
            // Set the analyzed URL in the results title
            document.getElementById('analyzed-url').textContent = url;
            
            console.log('URL:', url);
            console.log('Search Type:', searchType);
            
            // Show spinner and hide previous results/errors
            spinner.style.display = 'block';
            if (results) results.style.display = 'none';
            if (errorDiv) errorDiv.classList.add('d-none');

            // Clean up existing DataTables instances
            if ($.fn.DataTable.isDataTable('#domain-table')) {
                $('#domain-table').DataTable().destroy();
            }
            if ($.fn.DataTable.isDataTable('#headers-table')) {
                $('#headers-table').DataTable().destroy();
            }
            
            // Clear all previous results and reset displays
            document.getElementById('domain-results').innerHTML = '';
            document.getElementById('headers-results').innerHTML = '';
            document.getElementById('ssl-certificate-results').innerHTML = '';
            document.getElementById('domain-info').style.display = 'none';
            document.getElementById('headers-info').style.display = 'none';
            document.getElementById('ssl-certificate').style.display = 'none';
            document.getElementById('timeline').style.display = 'none';
            
            // Clear timeline if it exists
            if (timeline) {
                timelineItems.clear();
            }

            try {
                console.log('Sending request...');
                const response = await fetch('/analyze', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        url: url,
                        searchType: searchType
                    })
                });

                console.log('Response received:', response.status);
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                console.log('Data received:', data);
                
                // Create timeline with the received data
                createTimeline(data);
                
                // Show results based on search type
                if (searchType === 'all') {
                    if (data.rdap && data.rdap.length > 0) {
                        document.getElementById('domain-info').style.display = 'block';
                        displayDomainResults(data.rdap);
                    }
                    if (data.headers && data.headers.length > 0) {
                        document.getElementById('headers-info').style.display = 'block';
                        displayHeadersResults(data.headers);
                    }
                    if (data.certs) {
                        document.getElementById('ssl-certificate').style.display = 'block';
                        displayCertificateResults(data.certs);
                    }
                } else if (searchType === 'rdap' && data) {
                    document.getElementById('domain-info').style.display = 'block';
                    displayDomainResults(data);
                } else if (searchType === 'headers' && data) {
                    document.getElementById('headers-info').style.display = 'block';
                    displayHeadersResults(data);
                } else if (searchType === 'certs' && data) {
                    document.getElementById('ssl-certificate').style.display = 'block';
                    displayCertificateResults(data);
                }
                
                results.style.display = 'block';
                
            } catch (error) {
                console.error('Error:', error);
                errorDiv.textContent = error.message;
                errorDiv.classList.remove('d-none');
            } finally {
                spinner.style.display = 'none';
            }
        });
    });

    function displayDomainResults(data) {
        const tbody = document.getElementById('domain-results');
        tbody.innerHTML = '';
        
        if (!data || !data.length) return;

        // Check if the response contains an error
        if (data[0].error) {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td colspan="3" class="text-danger">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                    ${data[0].error}
                </td>
            `;
            tbody.appendChild(row);
            return;
        }

        // Destroy existing DataTable if it exists
        if ($.fn.DataTable.isDataTable('#domain-table')) {
            $('#domain-table').DataTable().destroy();
        }

        // Display the data
        data.forEach(item => {
            // Parse the date string into a timestamp for sorting
            const [date, time] = item.last_modified.split(' ');
            const [day, month, year] = date.split('-');
            const timestamp = new Date(`${year}-${month}-${day} ${time}`).getTime();
            
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${item.type}</td>
                <td><a href="${item.url}" target="_blank">${item.url}</a></td>
                <td data-order="${timestamp}">${item.last_modified}</td>
            `;
            tbody.appendChild(row);
        });

        // Initialize DataTable with sorting
        $('#domain-table').DataTable({
            order: [[2, 'asc']], // Sort by time column ascending by default (oldest first)
            columnDefs: [{
                targets: 2,
                type: 'num'  // Use numeric sorting for timestamps
            }]
        });
    }

    function displayHeadersResults(data) {
        const tbody = document.getElementById('headers-results');
        const filterValue = document.getElementById('type-filter').value;
        tbody.innerHTML = '';
        
        if (!data || !data.length) return;

        // Store the data for filtering
        window.headerResults = data;

        // Destroy existing DataTable if it exists
        if ($.fn.DataTable.isDataTable('#headers-table')) {
            $('#headers-table').DataTable().destroy();
        }

        let filteredResults = [...data];
        if (filterValue !== 'all') {
            filteredResults = filteredResults.filter(item => 
                item.type.toLowerCase() === filterValue.toLowerCase()
            );
        }

        // Display the data
        filteredResults.forEach(item => {
            // Parse the date string into a timestamp for sorting
            const [date, time] = item.last_modified.split(' ');
            const [day, month, year] = date.split('-');
            const timestamp = new Date(`${year}-${month}-${day} ${time}`).getTime();
            
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${item.type}</td>
                <td><a href="${item.url}" target="_blank">${item.url}</a></td>
                <td data-order="${timestamp}">${item.last_modified}</td>
            `;
            tbody.appendChild(row);
        });

        // Initialize DataTable with sorting
        $('#headers-table').DataTable({
            order: [[2, 'asc']], // Sort by last modified column ascending by default (oldest first)
            columnDefs: [{
                targets: 2,
                type: 'num'  // Use numeric sorting for timestamps
            }]
        });
    }

    function displayCertificateResults(data) {
        const tbody = document.getElementById('ssl-certificate-results');
        tbody.innerHTML = '';  // Clear existing results
        
        if (!data || !Array.isArray(data)) {
            data = [data];  // Convert single object to array
        }
        
        data.forEach(item => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${item.type}</td>
                <td>${item['Common Name']}</td>
                <td>${item['First Seen']}</td>
                <td>${item['Valid From']}</td>
                <td><a href="${item['Source']}" target="_blank">View Certificate</a></td>
            `;
            tbody.appendChild(row);
        });
        
        document.getElementById('ssl-certificate').style.display = 'block';
    }

    function filterHeadersResults() {
        displayHeadersResults(window.headerResults);
    }

    // Add export functions
    async function exportTable(type) {
        const url = document.getElementById('url').value;
        const domain = url.replace(/^https?:\/\//, '').split('/')[0];
        let tableData;
        
        if (type === 'rdap') {
            tableData = Array.from(document.getElementById('domain-results').children).map(row => ({
                type: row.children[0].textContent,
                url: row.children[1].firstChild.href,
                last_modified: row.children[2].textContent
            }));
        } else if (type === 'certs') {
            tableData = Array.from(document.getElementById('ssl-certificate-results').children).map(row => ({
                type: row.children[0].textContent,
                common_name: row.children[1].textContent,
                first_seen: row.children[2].textContent,
                valid_from: row.children[3].textContent,
                source: row.children[4].firstChild.href
            }));
        } else {
            tableData = Array.from(document.getElementById('headers-results').children).map(row => ({
                type: row.children[0].textContent,
                url: row.children[1].firstChild.href,
                last_modified: row.children[2].textContent
            }));
        }

        try {
            const response = await fetch(`/export/${type}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    domain: domain,
                    table_data: tableData
                })
            });
            
            if (!response.ok) throw new Error('Export failed');
            
            // Get the filename from the Content-Disposition header
            const contentDisposition = response.headers.get('Content-Disposition');
            let filename = '';
            if (contentDisposition && contentDisposition.includes('filename=')) {
                filename = contentDisposition.split('filename=')[1].replace(/"/g, '');
            } else {
                // Fallback filename format
                const timestamp = new Date().toISOString().slice(0,10).replace(/-/g,'');
                filename = `${domain}_${timestamp}_${type}.csv`;
            }
            
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
        } catch (error) {
            console.error('Export error:', error);
            alert('Error exporting data');
        }
    }

    async function exportAll() {
        const url = document.getElementById('url').value;
        const domain = url.replace(/^https?:\/\//, '').split('/')[0];
        
        let data = {
            domain: domain,
            rdap_data: [],
            headers_data: [],
            cert_data: []
        };
        
        // Collect all available data based on what's displayed
        if (document.getElementById('domain-info').style.display !== 'none') {
            data.rdap_data = Array.from(document.getElementById('domain-results').children).map(row => ({
                type: row.children[0].textContent,
                url: row.children[1].firstChild.href,
                last_modified: row.children[2].textContent
            }));
        }
        
        if (document.getElementById('headers-info').style.display !== 'none') {
            data.headers_data = Array.from(document.getElementById('headers-results').children).map(row => ({
                type: row.children[0].textContent,
                url: row.children[1].firstChild.href,
                last_modified: row.children[2].textContent
            }));
        }
        
        if (document.getElementById('ssl-certificate').style.display !== 'none') {
            data.cert_data = Array.from(document.getElementById('ssl-certificate-results').children).map(row => ({
                type: row.children[0].textContent,
                common_name: row.children[1].textContent,
                first_seen: row.children[2].textContent,
                valid_from: row.children[3].textContent,
                source: row.children[4].firstChild.href
            }));
        }

        try {
            const response = await fetch('/export/all', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            });
            
            if (!response.ok) throw new Error('Export failed');
            
            // Get the filename from the Content-Disposition header
            const contentDisposition = response.headers.get('Content-Disposition');
            let filename = '';
            if (contentDisposition && contentDisposition.includes('filename=')) {
                filename = contentDisposition.split('filename=')[1].replace(/"/g, '');
            } else {
                // Fallback filename format
                const timestamp = new Date().toISOString().slice(0,10).replace(/-/g,'');
                filename = `${domain}_${timestamp}_all.zip`;
            }
            
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
        } catch (error) {
            console.error('Export error:', error);
            alert('Error exporting data');
        }
    }
    </script>
</body>
</html> 