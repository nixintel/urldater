{% extends "base.html" %}

{% block title %}Home{% endblock %}

{% block extra_css %}
<link href="https://cdn.datatables.net/1.10.18/media/css/jquery.dataTables.min.css" rel="stylesheet">

<script type="module" src="https://cdnjs.cloudflare.com/ajax/libs/vis-timeline/8.2.1/vis-timeline-graph2d.esm.js"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/vis-timeline/8.2.1/vis-timeline-graph2d.min.css" rel="stylesheet" type="text/css" />
<style>
    .table { margin-top: 20px; }
    #results { margin-top: 30px; }
    /* ... rest of your existing styles ... */
    .spinner-container {
        display: none;
        margin: 20px 0;
        text-align: center;
    }
    .spinner-text {
        margin-top: 10px;
        font-style: italic;
        color: #666;
    }
    .sort-button {
        background: none;
        border: none;
        padding: 0 5px;
        cursor: pointer;
    }
    .filter-controls {
        margin-bottom: 15px;
    }
    .table-controls {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
    }
    #timeline {
        display: none;
        margin: 20px 0;
        padding: 20px;
        border: 1px solid #ddd;
        border-radius: 4px;
    }
    #visualization {
        height: 300px;
    }
    .timeline-rdap {
        background-color: #007bff !important;
        color: white !important;
        border-color: #0056b3 !important;
    }
    .timeline-cert {
        background-color: #dc3545 !important;
        color: white !important;
        border-color: #bd2130 !important;
    }
    .timeline-header {
        background-color: #28a745 !important;
        color: white !important;
        border-color: #1e7e34 !important;
    }
    .timeline-favicon {
        background-color: #ffc107 !important;
        color: black !important;
        border-color: #d39e00 !important;
    }
    .dataTables_wrapper .dataTables_filter {
        float: right;
        margin-bottom: 10px;
    }
    
    .dataTables_wrapper .dataTables_length {
        float: left;
        margin-bottom: 10px;
    }
    
    .dataTables_wrapper .dataTables_paginate .paginate_button {
        padding: 0.5em 1em;
        margin-left: 2px;
        border: 1px solid #ddd;
        border-radius: 3px;
        background-color: #fff;
    }
    
    .dataTables_wrapper .dataTables_paginate .paginate_button:hover {
        background-color: #e9ecef;
        border-color: #dee2e6;
    }
    
    .dataTables_wrapper .dataTables_paginate .paginate_button.current {
        background-color: #007bff;
        border-color: #007bff;
        color: white !important;
    }
    
    /* Clear the float after the length and filter */
    .dataTables_wrapper::after {
        content: "";
        display: table;
        clear: both;
    }
    
    /* Update the DataTables wrapper styles */
    .dataTables_wrapper {
        margin-top: 20px;
    }
    
    /* Style for the entries info text */
    .dataTables_info {
        padding-top: 0.85em !important;
        clear: both;
        margin-bottom: 1em;
    }
    
    /* Style for the pagination buttons */
    .dataTables_wrapper .dataTables_paginate {
        padding-top: 0.5em;
        clear: both;
    }
    
    .dataTables_wrapper .dataTables_paginate .paginate_button {
        padding: 0.5em 1em;
        margin-left: 5px;
        border: none;
        border-radius: 4px;
        background-color: #0d6efd !important;  /* Bootstrap primary color */
        color: white !important;
    }
    
    .dataTables_wrapper .dataTables_paginate .paginate_button:hover {
        background-color: #0b5ed7 !important;  /* Bootstrap primary hover color */
        border: none;
    }
    
    .dataTables_wrapper .dataTables_paginate .paginate_button.disabled {
        background-color: #6c757d !important;  /* Bootstrap secondary color */
        opacity: 0.65;
        cursor: not-allowed;
    }
    
    /* Remove DataTables default button styles */
    .dataTables_wrapper .dataTables_paginate .paginate_button:active,
    .dataTables_wrapper .dataTables_paginate .paginate_button:focus {
        box-shadow: none;
        outline: none;
    }
    
    /* Export buttons and indicators */
    .btn-export, .export-btn, #exportAllBtn {
        background-color: #007bff;
        color: white;
        transition: all 0.3s ease;
    }
    
    .btn-export:hover, .export-btn:hover, #exportAllBtn:hover {
        background-color: #0069d9;
        color: white;
        transform: translateY(-1px);
    }

    .btn-export i, .export-btn i {
        margin-right: 5px;
    }

    #export-spinner {
        width: 1.5rem;
        height: 1.5rem;
        margin-top: 5px;
    }

    #form-info {
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        padding: 20px;
    }

    #form-info h1 {
        font-size: 1.5rem;
        margin-bottom: 1rem;
    }

    #form-info ul {
        margin-bottom: 1rem;
    }

    #form-info blockquote {
        border-left: 4px solid #007bff;
        padding-left: 1rem;
        margin: 1rem 0;
        color: #6c757d;
    }

    /* Export button colors */
    .btn-export-png {
        background-color: #28a745;
    }
    
    .btn-export-png:hover {
        background-color: #218838;
    }
    
    .btn-export-pdf {
        background-color: #dc3545;
    }
    
    .btn-export-pdf:hover {
        background-color: #c82333;
    }

    /* Export button container */
    .export-buttons {
        display: flex;
        gap: 0.5rem;
        align-items: center;
    }

    /* Disable export buttons during export */
    .exporting {
        pointer-events: none;
        opacity: 0.7;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    
    <form id="searchForm">
        <div class="form-group">
            <div class="input-group">
                <input type="text" class="form-control" id="url" name="url" placeholder="Enter URL here..." required>
                <button type="submit" class="btn btn-primary">Analyze</button>
            </div>
        </div>
        
        <div class="form-group mt-3 d-flex gap-4">
            <div class="form-check">
                <input class="form-check-input" type="radio" name="searchType" id="allTypes" value="all" checked>
                <label class="form-check-label" for="allTypes">
                    All Analysis Types
                    <i class="bi bi-info-circle ms-1" data-bs-toggle="tooltip" data-bs-placement="top" 
                       title="Performs all available checks: domain age via RDAP, SSL certificates history from crt.sh, and last-modified headers for all media files. These techniques are a mix of active and passive."></i>
                </label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="radio" name="searchType" id="rdapOnly" value="rdap">
                <label class="form-check-label" for="rdapOnly">
                    Domain History Only
                    <i class="bi bi-info-circle ms-1" data-bs-toggle="tooltip" data-bs-placement="top" 
                       title="Checks domain registration and update history using RDAP data. This is a passive technique and will not interact with the target website."></i>
                </label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="radio" name="searchType" id="certsOnly" value="certs">
                <label class="form-check-label" for="certsOnly">
                    Certificate History Only
                    <i class="bi bi-info-circle ms-1" data-bs-toggle="tooltip" data-bs-placement="top" 
                       title="Retrieves SSL certificate history from crt.sh database. This is a passive technique and will not interact with the target website."></i>
                </label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="radio" name="searchType" id="headersOnly" value="headers">
                <label class="form-check-label" for="headersOnly">
                    Last-Modified Headers Only
                    <i class="bi bi-info-circle ms-1" data-bs-toggle="tooltip" data-bs-placement="top" 
                       title="Checks last-modified dates for all media files (images, favicons) on the webpage. This is an active technique and will interact with the target website."></i>
                </label>
            </div>
        </div>
    </form>

    <!-- Form Info Section -->
    <div id="form-info" class="mt-4">
        {% filter markdown %}
            {% include 'form_info.md' %}
        {% endfilter %}
    </div>

    <!-- Loading Spinner -->
    <div id="spinner" class="spinner-container">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <div class="spinner-text">Analyzing URL... This may take a few moments.</div>
    </div>

    <div id="results" class="mt-4" style="display: none;">
        <!-- Add URL title and Export All button at the top -->
        <h2 class="mb-3">Results for URL: <span id="analyzed-url" class="text-primary"></span></h2>
        <div class="mb-4 export-buttons">
            <button class="btn btn-primary btn-export" onclick="exportAll()">
                <i class="bi bi-file-earmark-arrow-down"></i> Export All Data
            </button>
            <button class="btn btn-success btn-export-png" onclick="exportAsPNG()">
                <i class="bi bi-file-image"></i> Save as PNG
            </button>
            <button class="btn btn-danger btn-export-pdf" onclick="exportAsPDF()">
                <i class="bi bi-file-pdf"></i> Save as PDF
            </button>
            
        </div>

        <div id="domain-info" class="mt-4">
            <h3>Domain Information</h3>
            <div class="table-controls">
                <button class="btn btn-primary" onclick="exportTable('rdap')">Export RDAP Data</button>
            </div>
            <table class="table table-striped" id="domain-table">
                <thead>
                    <tr>
                        <th>Type</th>
                        <th>URL</th>
                        <th>Time</th>
                    </tr>
                </thead>
                <tbody id="domain-results">
                </tbody>
            </table>
        </div>

        <!-- Certificate table with export button -->
        <div id="ssl-certificate" class="mt-4">
            <h3>SSL Certificate Information</h3>
            <div class="table-controls">
                <button class="btn btn-primary" onclick="exportTable('certs')">Export Certificate Data</button>
            </div>
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Type</th>
                        <th>Common Name</th>
                        <th>First Seen</th>
                        <th>Valid From</th>
                        <th>Source</th>
                    </tr>
                </thead>
                <tbody id="ssl-certificate-results">
                </tbody>
            </table>
        </div>

        <div id="headers-info" class="mt-4">
            <h3>Last Modified Headers</h3>
            <div class="table-controls">
                <div>
                    <button class="btn btn-primary" onclick="exportTable('headers')">Export Headers Data</button>
                    <select id="type-filter" class="form-select d-inline-block w-auto ms-2" onchange="filterHeadersResults()">
                        <option value="all">All Types</option>
                        <option value="favicon">Favicon</option>
                        <option value="image">Image</option>
                    </select>
                </div>
            </div>
            <table class="table table-striped" id="headers-table">
                <thead>
                    <tr>
                        <th>Type</th>
                        <th>URL</th>
                        <th>Last Modified</th>
                    </tr>
                </thead>
                <tbody id="headers-results">
                </tbody>
            </table>
        </div>
    </div>

    <!-- First, make sure the timeline container is properly structured -->
    <div id="timeline" class="mt-4">
        <h3>Timeline</h3>
        <div class="mb-3">
            <div class="form-check form-check-inline">
                <input class="form-check-input" type="checkbox" id="showRdap" checked>
                <label class="form-check-label" for="showRdap">
                    <span class="badge bg-primary">Domain Registration Events</span>
                </label>
            </div>
            <div class="form-check form-check-inline">
                <input class="form-check-input" type="checkbox" id="showCerts" checked>
                <label class="form-check-label" for="showCerts">
                    <span class="badge bg-danger">First SSL Certificate</span>
                </label>
            </div>
            <div class="form-check form-check-inline">
                <input class="form-check-input" type="checkbox" id="showHeaders" checked>
                <label class="form-check-label" for="showHeaders">
                    <span class="badge bg-success">Image Last Modified</span>
                </label>
            </div>
        </div>
        <div id="visualization"></div>
    </div>

    <div id="error" class="alert alert-danger d-none"></div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.datatables.net/1.10.24/js/jquery.dataTables.min.js"></script>
<!-- Load our external JS files -->
<script type="module" src="{{ url_for('static', filename='js/main.js') }}"></script>
<script type="module" src="{{ url_for('static', filename='js/timeline.js') }}"></script>
<script src="{{ url_for('static', filename='js/data.js') }}"></script>
<script src="{{ url_for('static', filename='js/export.js') }}"></script>
{% endblock %} 